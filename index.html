<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penyusun Rencana Pembelajaran Mendalam (RPM) Interaktif</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- 
        Change Log (FIX):
        - Fixed all broken src/href attributes that were incorrectly wrapped in Markdown link format.
        - Rewrote the "Isi Otomatis" (generateAllAiContent) function to run AI requests concurrently using Promise.allSettled for much faster performance.
        - Added a full-screen loader overlay to provide better feedback during the bulk generation process.
        - Disabled the "Isi Otomatis" button while it's running to prevent multiple clicks.
    -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            color: #374151;
        }
        .section-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            border: 1px solid #e5e7eb;
        }
        .rpm-section {
            display: flex;
            flex-direction: column;
            background-color: white;
            border-radius: 0.75rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        .rpm-row {
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid #e5e7eb;
        }
        .rpm-row:last-child {
            border-bottom: none;
        }
        .rpm-category {
            width: 100%;
            padding: 1rem 1.5rem;
            background-color: #1e3a8a;
            border-bottom: 1px solid #1e3a8a;
        }
        .rpm-category h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #ffffff;
        }
        .rpm-content {
            width: 100%;
            padding: 1.5rem;
        }
        #umum .rpm-content {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        @media (min-width: 768px) {
            .rpm-section { flex-direction: row; }
            .rpm-row { flex-direction: row; }
            .rpm-category {
                width: 25%;
                border-right: 1px solid #1e3a8a;
                border-bottom: none;
                display: flex;
                align-items: center;
                justify-content: flex-start;
            }
            .rpm-category h3 { font-size: 1.125rem; }
            .rpm-content { width: 75%; }
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e3a8a;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #dbeafe;
            padding-bottom: 0.5rem;
        }
        .input-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #4b5563;
        }
        .text-input, .textarea-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .text-input:focus, .textarea-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px #bfdbfe;
        }
        .textarea-input {
            min-height: 120px;
            resize: vertical;
        }
        .nav-link {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s, color 0.3s;
            color: #1e40af;
            font-weight: 500;
        }
        .nav-link:hover, .nav-link.active {
            background-color: #3b82f6;
            color: white;
        }
        .action-button {
            background-color: #2563eb;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.3s;
            border: 1px solid transparent;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .action-button:hover { background-color: #1d4ed8; }
        .action-button.secondary { background-color: #e0e7ff; color: #3730a3; border-color: #c7d2fe; }
        .action-button.secondary:hover { background-color: #c7d2fe; }
        .action-button.danger { background-color: #fee2e2; color: #991b1b; border-color: #fecaca; }
        .action-button.danger:hover { background-color: #fecaca; }
        .ai-button {
            background-color: #ede9fe;
            color: #5b21b6;
            font-size: 0.875rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            transition: background-color 0.2s;
        }
        .ai-button:hover { background-color: #ddd6fe; }
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(17, 24, 39, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            width: 90%;
            max-width: 500px;
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        #toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(200%);
            background-color: #22c55e;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.5s ease-in-out;
            z-index: 100;
        }
        #toast.show { transform: translateX(-50%) translateY(0); }
        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid #ddd;
            border-bottom-color: #5b21b6;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .autocomplete-item {
            padding: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .autocomplete-item:hover {
            background-color: #eef2ff;
        }

        @media print {
            body { font-size: 9pt; line-height: 1.2; background-color: white; }
            header, .action-buttons, .print-info, footer, .ai-button, #upload-signature-btn { display: none; }
            main { 
                padding: 0 !important; 
                margin: 0 auto !important;
                max-width: 18cm;
            }
            h1 { font-size: 18pt; margin-bottom: 1rem !important; }
            .section-card, .rpm-section { box-shadow: none; border: 1px solid #cccccc; padding: 0.5rem; margin-bottom: 1rem; page-break-inside: avoid; }
            .rpm-row { border-bottom: 1px solid #cccccc; }
            .rpm-content { padding: 0.5rem 1rem; }
            .rpm-category { background-color: #1e3a8a !important; border-right-color: #1e3a8a !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            .rpm-category h3 { color: #ffffff !important; }
            .section-title { font-size: 14pt; color: black; border-bottom: 1px solid #d1d5db; padding-bottom: 0.25rem; margin-bottom: 0.75rem; }
            .input-label { margin-bottom: 0.2rem; }
            .text-input, .textarea-input { border: none; padding: 0; background-color: #f9fafb !important; -webkit-print-color-adjust: exact; color-adjust: exact; border-radius: 0; min-height: auto; color: black !important; height: auto !important; overflow: visible !important; }
            .textarea-input { padding: 0.5rem; border: 1px dashed #d1d5db; }
            p, .input-label { color: black !important; }

            #pengesahan img, #lampiran img {
                display: block !important;
                max-height: 1.5cm !important;
                width: auto !important;
                margin: 0 auto !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            #guru-signature-img.hidden {
                display: none !important;
            }
        }
    </style>
</head>
<body class="antialiased">

    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-10 shadow-sm border-b border-gray-200">
        <nav class="container mx-auto px-4 lg:px-8 py-3">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div>
                    <h1 class="text-xl font-bold text-blue-800">RPM Interaktif</h1>
                    <p class="text-sm font-semibold text-gray-700 -mt-1">SMK N 1 Purbalingga</p>
                </div>
                <div class="hidden md:flex flex-wrap items-center gap-2">
                    <a href="#umum" class="nav-link active">Informasi Umum</a>
                    <a href="#identifikasi" class="nav-link">Identifikasi</a>
                    <a href="#desain" class="nav-link">Desain</a>
                    <a href="#pengalaman" class="nav-link">Pengalaman</a>
                    <a href="#asesmen" class="nav-link">Asesmen</a>
                    <a href="#pengesahan" class="nav-link">Pengesahan</a>
                    <a href="#lampiran" class="nav-link">Lampiran</a>
                </div>
                <div class="action-buttons flex items-center gap-2">
                    <button id="generateAllBtn" title="Isi Otomatis Semua Bagian Berdasarkan Tujuan Pembelajaran" class="action-button bg-violet-600 hover:bg-violet-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H5zm0 2h10v7h-2.586l-1.707 1.707A.5.5 0 0110 14v-1H5V5z" /></svg>
                        <span class="hidden sm:inline">Isi Otomatis</span>
                    </button>
                     <button id="saveBtn" title="Simpan Progres" class="action-button secondary">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v12a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm3 0a1 1 0 011-1h2a1 1 0 011 1v3a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" /></svg>
                         <span class="hidden sm:inline">Simpan</span>
                     </button>
                     <button id="clearBtn" title="Kosongkan Isian" class="action-button danger">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                         <span class="hidden sm:inline">Kosongkan</span>
                     </button>
                     <button id="printBtn" title="Cetak RPM" class="action-button">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg>
                         <span class="hidden sm:inline">Cetak</span>
                     </button>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 lg:px-8 py-8">
        <h1 class="text-3xl font-bold text-center text-blue-800 mb-8">Rencana Pembelajaran Mendalam</h1>

        <!-- Bagian Informasi Umum (Konteks untuk AI) -->
        <div id="umum" class="rpm-section scroll-mt-24">
            <div class="rpm-category"><h3>Informasi Umum</h3></div>
            <div class="w-full">
                <div class="rpm-row"><div class="rpm-content w-full grid grid-cols-1 md:grid-cols-3 items-center gap-2 md:gap-4"><label class="input-label md:col-span-1" for="satuan-pendidikan">Satuan Pendidikan</label><div class="md:col-span-2"><input type="text" id="satuan-pendidikan" class="text-input" value="SMK Negeri 1 Purbalingga" readonly></div></div></div>
                <div class="rpm-row"><div class="rpm-content w-full grid grid-cols-1 md:grid-cols-3 items-start gap-2 md:gap-4"><label class="input-label md:col-span-1 pt-2" for="nama-guru">Nama Guru & NIP</label><div class="md:col-span-2 grid grid-cols-2 gap-4"><div class="relative"><input type="text" id="nama-guru" class="text-input" placeholder="Ketik nama guru..." autocomplete="off"><div id="autocomplete-list" class="absolute z-20 w-full bg-white border border-gray-300 rounded-b-md shadow-lg max-h-60 overflow-y-auto hidden"></div></div><input type="text" id="nip-guru" class="text-input" placeholder="NIP..."></div></div></div>
                <div class="rpm-row"><div class="rpm-content w-full grid grid-cols-1 md:grid-cols-3 items-center gap-2 md:gap-4"><label class="input-label md:col-span-1" for="kelas">Kelas/ Semester/ Fase</label><div class="md:col-span-2 grid grid-cols-3 gap-4"><input type="text" id="kelas" class="text-input" placeholder="X"><input type="text" id="semester" class="text-input" placeholder="Ganjil"><input type="text" id="fase" class="text-input" placeholder="E"></div></div></div>
                <div class="rpm-row"><div class="rpm-content w-full grid grid-cols-1 md:grid-cols-3 items-center gap-2 md:gap-4"><label class="input-label md:col-span-1" for="mata-pelajaran">Mata Pelajaran</label><div class="md:col-span-2"><input type="text" id="mata-pelajaran" class="text-input" placeholder="Contoh: Dasar-dasar Teknik Otomotif"></div></div></div>
                <div class="rpm-row"><div class="rpm-content w-full grid grid-cols-1 md:grid-cols-3 items-center gap-2 md:gap-4"><label class="input-label md:col-span-1" for="elemen">Elemen</label><div class="md:col-span-2"><input type="text" id="elemen" class="text-input" placeholder="Contoh: Proses bisnis bidang otomotif"></div></div></div>
                <div class="rpm-row"><div class="rpm-content w-full grid grid-cols-1 md:grid-cols-3 items-center gap-2 md:gap-4"><label class="input-label md:col-span-1" for="materi-ajar">Materi Ajar/ Topik</label><div class="md:col-span-2"><input type="text" id="materi-ajar" class="text-input" placeholder="Contoh: K3 di tempat kerja"></div></div></div>
                <div class="rpm-row"><div class="rpm-content w-full grid grid-cols-1 md:grid-cols-3 items-center gap-2 md:gap-4"><label class="input-label md:col-span-1" for="alokasi-waktu">Alokasi Waktu</label><div class="md:col-span-2"><input type="text" id="alokasi-waktu" class="text-input" placeholder="Contoh: 6 JP (2 x Pertemuan)"></div></div></div>
            </div>
        </div>
       
        <!-- Bagian Identifikasi -->
        <div id="identifikasi" class="rpm-section scroll-mt-24">
            <div class="rpm-category"><h3>Identifikasi</h3></div>
            <div class="w-full">
                <div class="rpm-row">
                    <div class="rpm-content w-full">
                        <div class="flex justify-between items-center mb-2">
                            <label for="identifikasi-peserta" class="input-label !mb-0">Peserta Didik</label>
                            <button data-target="identifikasi-peserta" data-prompt-key="identifikasi_murid" data-title="Identifikasi Peserta Didik" class="ai-button flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(45 10 10)"></path></svg>
                                Buat dengan AI
                            </button>
                        </div>
                        <textarea id="identifikasi-peserta" class="textarea-input" placeholder="Jelaskan hasil identifikasi kesiapan peserta didik, minat, latar belakang, dan kebutuhan belajar, serta aspek lainnya."></textarea>
                    </div>
                </div>
                <div class="rpm-row">
                    <div class="rpm-content w-full">
                        <div class="flex justify-between items-center mb-2">
                            <label for="identifikasi-materi" class="input-label !mb-0">Materi Pelajaran</label>
                            <button data-target="identifikasi-materi" data-prompt-key="identifikasi_materi" data-title="Identifikasi Materi" class="ai-button flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(45 10 10)"></path></svg>
                                Buat dengan AI
                            </button>
                        </div>
                        <textarea id="identifikasi-materi" class="textarea-input" placeholder="Jelaskan identifikasi materi pelajaran faktual, konseptual, prosedural..."></textarea>
                    </div>
                </div>
                <div class="rpm-row"><div class="rpm-content w-full"><label class="input-label">Dimensi Profil Lulusan</label><div id="dimensi-profil" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mt-2"><label class="flex items-center space-x-2"><input type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 rounded"><span>Keimanan dan Ketaqwaan...</span></label><label class="flex items-center space-x-2"><input type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 rounded"><span>Penalaran Kritis</span></label><label class="flex items-center space-x-2"><input type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 rounded"><span>Kolaborasi</span></label><label class="flex items-center space-x-2"><input type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 rounded"><span>Kesehatan</span></label><label class="flex items-center space-x-2"><input type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 rounded"><span>Kewargaan</span></label><label class="flex items-center space-x-2"><input type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 rounded"><span>Kreativitas</span></label><label class="flex items-center space-x-2"><input type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 rounded"><span>Kemandirian</span></label><label class="flex items-center space-x-2"><input type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 rounded"><span>Komunikasi</span></label></div></div></div>
            </div>
        </div>

        <!-- Bagian Desain Pembelajaran (RESTRUCTURED) -->
        <div id="desain" class="rpm-section scroll-mt-24">
            <div class="rpm-category"><h3>Desain Pembelajaran</h3></div>
            <div class="w-full">
                <div class="rpm-row">
                    <div class="rpm-content w-full">
                        <label for="desain-capaian" class="input-label">Capaian Pembelajaran</label>
                        <textarea id="desain-capaian" class="textarea-input" placeholder="Contoh: Di akhir fase E peserta dapat menyelesaikan sistem persamaan linear dua variabel melalui beberapa cara untuk penyelesaian masalah."></textarea>
                    </div>
                </div>
                <div class="rpm-row">
                    <div class="rpm-content w-full">
                        <div class="flex justify-between items-center mb-2">
                            <label for="desain-lintas-disiplin" class="input-label !mb-0">Lintas Disiplin Ilmu</label>
                            <button data-target="desain-lintas-disiplin" data-prompt-key="lintas_disiplin" data-title="Lintas Disiplin Ilmu" class="ai-button flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(45 10 10)"></path></svg>
                                Buat dengan AI
                            </button>
                        </div>
                        <textarea id="desain-lintas-disiplin" class="textarea-input" placeholder="Jelaskan integrasi dengan mata pelajaran lain..."></textarea>
                    </div>
                </div>
                 <div class="rpm-row">
                    <div class="rpm-content w-full">
                        <div class="flex justify-between items-center mb-2">
                            <label for="desain-tujuan" class="input-label !mb-0">Tujuan Pembelajaran</label>
                             <button data-target="desain-tujuan" data-prompt-key="tujuan_pembelajaran" data-title="Tujuan Pembelajaran" class="ai-button flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(45 10 10)"></path></svg>
                                Buat dengan AI
                            </button>
                        </div>
                        <textarea id="desain-tujuan" class="textarea-input" placeholder="Tuliskan tujuan pembelajaran yang spesifik dan terukur (ABCD)..."></textarea>
                    </div>
                </div>
                <div class="rpm-row">
                    <div class="rpm-content w-full">
                        <div class="flex justify-between items-center mb-2">
                            <label for="desain-topik" class="input-label !mb-0">Topik Pembelajaran</label>
                            <button data-target="desain-topik" data-prompt-key="topik_pembelajaran" data-title="Topik Pembelajaran" class="ai-button flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(45 10 10)"></path></svg>
                                Buat dengan AI
                            </button>
                        </div>
                        <textarea id="desain-topik" class="textarea-input" placeholder="Rekomendasi topik per pertemuan..."></textarea>
                    </div>
                </div>
                <div class="rpm-row">
                    <div class="rpm-content w-full">
                        <div class="flex justify-between items-center mb-2">
                            <label for="desain-pedagogis" class="input-label !mb-0">Praktik Pedagogis</label>
                             <button data-target="desain-pedagogis" data-prompt-key="praktik_pedagogis" data-title="Praktik Pedagogis" class="ai-button flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(45 10 10)"></path></svg>
                                Buat dengan AI
                            </button>
                        </div>
                        <textarea id="desain-pedagogis" class="textarea-input" placeholder="Rekomendasi Model/Strategi/Metode per pertemuan..."></textarea>
                    </div>
                </div>
                <div class="rpm-row">
                    <div class="rpm-content w-full">
                        <div class="flex justify-between items-center mb-2">
                            <label for="desain-kemitraan" class="input-label !mb-0">Kemitraan Pembelajaran</label>
                            <button data-target="desain-kemitraan" data-prompt-key="kemitraan_pembelajaran" data-title="Kemitraan Pembelajaran" class="ai-button flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(45 10 10)"></path></svg>
                                Buat dengan AI
                            </button>
                        </div>
                        <textarea id="desain-kemitraan" class="textarea-input" placeholder="Rekomendasi mitra kolaborasi (guru, orang tua, komunitas)..."></textarea>
                    </div>
                </div>
                <div class="rpm-row">
                    <div class="rpm-content w-full">
                        <div class="flex justify-between items-center mb-2">
                            <label for="desain-lingkungan" class="input-label !mb-0">Lingkungan Pembelajaran</label>
                            <button data-target="desain-lingkungan" data-prompt-key="lingkungan_pembelajaran" data-title="Lingkungan Pembelajaran" class="ai-button flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(45 10 10)"></path></svg>
                                Buat dengan AI
                            </button>
                        </div>
                        <textarea id="desain-lingkungan" class="textarea-input" placeholder="Desain lingkungan belajar (fisik, virtual, budaya)..."></textarea>
                    </div>
                </div>
                <div class="rpm-row">
                    <div class="rpm-content w-full">
                        <div class="flex justify-between items-center mb-2">
                            <label for="desain-digital" class="input-label !mb-0">Pemanfaatan Digital</label>
                            <button data-target="desain-digital" data-prompt-key="pemanfaatan_digital" data-title="Pemanfaatan Digital" class="ai-button flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(45 10 10)"></path></svg>
                                Buat dengan AI
                            </button>
                        </div>
                        <textarea id="desain-digital" class="textarea-input" placeholder="Rekomendasi 3 jenis pemanfaatan teknologi digital..."></textarea>
                    </div>
                </div>
            </div>
        </div>
       
        <!-- Bagian Pengalaman Belajar (RESTRUCTURED) -->
        <div id="pengalaman" class="rpm-section scroll-mt-24">
            <div class="rpm-category"><h3>Pengalaman Belajar</h3></div>
            <div class="w-full">
                <!-- AWAL -->
                <div class="rpm-row">
                    <div class="rpm-content w-full">
                        <div class="flex justify-between items-center mb-2">
                            <label for="pengalaman-awal" class="input-label !mb-0 font-medium text-gray-800">Langkah-langkah Pembelajaran: AWAL</label>
                            <button data-target="pengalaman-awal" data-prompt-key="pengalaman_awal" data-title="Kegiatan Awal" class="ai-button flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(45 10 10)"></path></svg>
                                Buat dengan AI
                            </button>
                        </div>
                        <textarea id="pengalaman-awal" class="textarea-input" placeholder="Kegiatan awal (apersepsi, motivasi, dll.) selama 15 menit..."></textarea>
                    </div>
                </div>
                <!-- INTI -->
                <div class="rpm-row">
                    <div class="rpm-content w-full">
                        <div class="flex justify-between items-center mb-2">
                            <label for="pengalaman-inti" class="input-label !mb-0 font-medium text-gray-800">Langkah-langkah Pembelajaran: INTI</label>
                            <button data-target="pengalaman-inti" data-prompt-key="pengalaman_inti" data-title="Kegiatan Inti" class="ai-button flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(45 10 10)"></path></svg>
                                Buat dengan AI
                            </button>
                        </div>
                        <p class="text-sm text-gray-500 mb-4">Aktivitas pembelajaran mendalam dengan tahapan Memahami, Mengaplikasikan, dan Merefleksi.</p>
                        <textarea id="pengalaman-inti" class="textarea-input" placeholder="Buatkan aktivitas pembelajaran mendalam yang mencakup tahapan Memahami, Mengaplikasikan, dan Merefleksi..."></textarea>
                    </div>
                </div>
                <!-- PENUTUP -->
                <div class="rpm-row">
                    <div class="rpm-content w-full">
                        <div class="flex justify-between items-center mb-2">
                            <label for="pengalaman-penutup" class="input-label !mb-0 font-medium text-gray-800">Langkah-langkah Pembelajaran: PENUTUP</label>
                            <button data-target="pengalaman-penutup" data-prompt-key="pengalaman_penutup" data-title="Kegiatan Penutup" class="ai-button flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(45 10 10)"></path></svg>
                                Buat dengan AI
                            </button>
                        </div>
                        <textarea id="pengalaman-penutup" class="textarea-input" placeholder="Kegiatan penutup (simpulan, umpan balik, doa) selama 5 menit..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bagian Asesmen (RESTRUCTURED) -->
        <div id="asesmen" class="rpm-section scroll-mt-24">
            <div class="rpm-category"><h3>Asesmen Pembelajaran</h3></div>
            <div class="w-full">
                 <!-- Asesmen Awal -->
                 <div class="rpm-row">
                    <div class="rpm-content w-full">
                        <div class="flex justify-between items-center mb-2">
                            <label for="asesmen-awal" class="input-label !mb-0 font-medium text-gray-800">Asesmen pada Awal Pembelajaran</label>
                            <button data-target="asesmen-awal" data-prompt-key="asesmen_awal" data-title="Asesmen Awal" class="ai-button flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(45 10 10)"></path></svg>
                                Buat dengan AI
                            </button>
                        </div>
                        <textarea id="asesmen-awal" class="textarea-input" placeholder="Jelaskan asesmen diagnostik untuk mengetahui kesiapan dan pengetahuan awal..."></textarea>
                    </div>
                </div>
                <!-- Asesmen Proses -->
                <div class="rpm-row">
                    <div class="rpm-content w-full">
                        <div class="flex justify-between items-center mb-2">
                            <label for="asesmen-proses" class="input-label !mb-0 font-medium text-gray-800">Asesmen pada Proses Pembelajaran</label>
                            <button data-target="asesmen-proses" data-prompt-key="asesmen_proses" data-title="Asesmen Proses" class="ai-button flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(45 10 10)"></path></svg>
                                Buat dengan AI
                            </button>
                        </div>
                        <textarea id="asesmen-proses" class="textarea-input" placeholder="Jelaskan asesmen formatif (observasi, diskusi, rubrik) untuk memantau proses belajar..."></textarea>
                    </div>
                </div>
                <!-- Asesmen Akhir -->
                <div class="rpm-row">
                    <div class="rpm-content w-full">
                        <div class="flex justify-between items-center mb-2">
                            <label for="asesmen-akhir" class="input-label !mb-0 font-medium text-gray-800">Asesmen pada Akhir Pembelajaran</label>
                            <button data-target="asesmen-akhir" data-prompt-key="asesmen_akhir" data-title="Asesmen Akhir" class="ai-button flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(45 10 10)"></path></svg>
                                Buat dengan AI
                            </button>
                        </div>
                        <textarea id="asesmen-akhir" class="textarea-input" placeholder="Jelaskan asesmen sumatif (tes, produk, kisi-kisi) untuk mengukur ketercapaian kompetensi..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <section id="pengesahan" class="section-card scroll-mt-24">
            <h2 class="section-title">Lembar Pengesahan</h2>
            <div class="flex justify-end pt-4"><div class="text-left"><p id="signature-date">Purbalingga, ..........................</p></div></div>
            <div class="flex flex-col md:flex-row justify-center items-start pt-2 text-center gap-8 md:gap-12">
                <div class="w-full md:w-auto md:max-w-[260px] flex-1">
                    <p>Mengetahui,</p>
                    <p class="font-semibold">Kepala Sekolah</p>
                    <div class="h-16 relative flex items-center justify-center my-1">
                        <img src="https://i.ibb.co/6gS4bC2/ttd-Kepala-Sekolah.png" alt="Tanda Tangan Kepala Sekolah" class="h-full">
                    </div>
                    <p class="font-semibold underline mt-1">Maryono S.Pd, M.Si</p>
                    <p class="text-sm">NIP. 19660701 2000121002</p>
                </div>
                <div class="w-full md:w-auto md:max-w-[260px] flex-1">
                    <p class="invisible md:visible">Placeholder</p>
                    <p class="font-semibold">Waka Kurikulum</p>
                     <div class="h-16 relative flex items-center justify-center my-1">
                        <img src="https://i.ibb.co/6r09yC6/ttd-Kurikulum.png" alt="Tanda Tangan Waka Kurikulum" class="h-full">
                    </div>
                    <p class="font-semibold underline mt-1">Satyo Nugroho, S.Kom</p>
                    <p class="text-sm">NIP. 197807142009031006</p>
                </div>
                <div class="w-full md:w-auto md:max-w-[260px] flex-1">
                    <p class="invisible md:visible">Placeholder</p>
                    <p class="font-semibold">Guru Mata Pelajaran</p>
                    <div class="h-16 relative flex items-center justify-center my-1">
                        <img id="guru-signature-img" class="hidden h-full" alt="Tanda Tangan Guru">
                    </div>
                    <button type="button" id="upload-signature-btn" class="text-sm text-blue-600 hover:underline -mt-1">Unggah Tanda Tangan</button>
                    <input type="file" id="signature-upload-input" class="hidden" accept="image/png, image/jpeg">
                    <p class="font-semibold underline mt-1" id="guru-name-signature">...................................</p>
                    <p class="text-sm" id="guru-nip-signature">NIP. .........................</p>
                </div>
            </div>
        </section>

        <!-- Bagian Lampiran (NEW SECTION) -->
        <div id="lampiran" class="rpm-section scroll-mt-24">
            <div class="rpm-category"><h3>Lampiran</h3></div>
            <div class="w-full">
                 <!-- Asesmen Diagnostik Non-Kognitif -->
                 <div class="rpm-row">
                    <div class="rpm-content w-full">
                        <div class="flex justify-between items-center mb-2">
                            <label for="lampiran-diagnostik" class="input-label !mb-0 font-medium text-gray-800">Asesmen Diagnostik Non-Kognitif</label>
                            <button data-target="lampiran-diagnostik" data-prompt-key="lampiran_diagnostik" data-title="Asesmen Diagnostik Non-Kognitif" class="ai-button flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(45 10 10)"></path></svg>
                                Buat dengan AI
                            </button>
                        </div>
                        <textarea id="lampiran-diagnostik" class="textarea-input" placeholder="Instrumen untuk mengukur minat, motivasi, gaya belajar, dll..."></textarea>
                    </div>
                </div>
                <!-- Rubrik Diskusi -->
                <div class="rpm-row">
                    <div class="rpm-content w-full">
                        <div class="flex justify-between items-center mb-2">
                            <label for="lampiran-rubrik-diskusi" class="input-label !mb-0 font-medium text-gray-800">Rubrik Penilaian Diskusi</label>
                            <button data-target="lampiran-rubrik-diskusi" data-prompt-key="lampiran_rubrik_diskusi" data-title="Rubrik Diskusi" class="ai-button flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(45 10 10)"></path></svg>
                                Buat dengan AI
                            </button>
                        </div>
                        <textarea id="lampiran-rubrik-diskusi" class="textarea-input" placeholder="Rubrik untuk menilai kolaborasi, penyampaian pendapat, dan kerja sama..."></textarea>
                    </div>
                </div>
                <!-- Rubrik Presentasi -->
                <div class="rpm-row">
                    <div class="rpm-content w-full">
                        <div class="flex justify-between items-center mb-2">
                            <label for="lampiran-rubrik-presentasi" class="input-label !mb-0 font-medium text-gray-800">Rubrik Penilaian Presentasi</label>
                            <button data-target="lampiran-rubrik-presentasi" data-prompt-key="lampiran_rubrik_presentasi" data-title="Rubrik Presentasi" class="ai-button flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(45 10 10)"></path></svg>
                                Buat dengan AI
                            </button>
                        </div>
                        <textarea id="lampiran-rubrik-presentasi" class="textarea-input" placeholder="Rubrik untuk menilai kemampuan berbicara, bertanya, dan kontribusi kelompok..."></textarea>
                    </div>
                </div>
                <!-- LKPD -->
                <div class="rpm-row">
                    <div class="rpm-content w-full">
                        <div class="flex justify-between items-center mb-2">
                            <label for="lampiran-lkpd" class="input-label !mb-0 font-medium text-gray-800">Lembar Kerja Peserta Didik (LKPD)</label>
                            <button data-target="lampiran-lkpd" data-prompt-key="lampiran_lkpd" data-title="LKPD" class="ai-button flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(45 10 10)"></path></svg>
                                Buat dengan AI
                            </button>
                        </div>
                        <textarea id="lampiran-lkpd" class="textarea-input" placeholder="LKPD lengkap dengan petunjuk, sintaks, dan tahapan memahami, mengaplikasikan, merefleksikan..."></textarea>
                    </div>
                </div>
                 <!-- Materi Ajar -->
                 <div class="rpm-row">
                    <div class="rpm-content w-full">
                        <div class="flex justify-between items-center mb-2">
                            <label for="lampiran-materi" class="input-label !mb-0 font-medium text-gray-800">Materi Ajar</label>
                            <button data-target="lampiran-materi" data-prompt-key="lampiran_materi" data-title="Materi Ajar" class="ai-button flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" transform="rotate(45 10 10)"></path></svg>
                                Buat dengan AI
                            </button>
                        </div>
                        <textarea id="lampiran-materi" class="textarea-input" placeholder="Materi ajar lengkap dengan judul, pendahuluan, isi, dan penutup..."></textarea>
                    </div>
                </div>
            </div>
        </div>


    </main>

    <footer class="text-center py-8 text-gray-500 text-sm">
        <p>RPM Interaktif dengan Bantuan AI.</p>
        <p>&copy; <span id="current-year"></span> SMK N 1 Purbalingga. All Rights Reserved.</p>
    </footer>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitle" class="text-xl font-bold text-gray-800 mb-2">Konfirmasi</h3>
            <p id="modalMessage" class="text-gray-600 mb-6">Apakah Anda yakin ingin melanjutkan?</p>
            <div class="flex justify-end gap-4">
                <button id="modalCancelBtn" class="action-button secondary">Batal</button>
                <button id="modalConfirmBtn" class="action-button">Yakin</button>
            </div>
        </div>
    </div>
   
    <!-- AI Generation Modal -->
    <div id="aiModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="aiModalTitle" class="text-xl font-bold text-violet-700 mb-2">Buat Konten dengan AI</h3>
            <p class="text-gray-600 mb-4">Berikan beberapa kata kunci atau deskripsi singkat untuk membantu AI menghasilkan konten yang lebih sesuai.</p>
            <div>
                <label for="ai-prompt-input" class="input-label">Kata Kunci (opsional)</label>
                <input type="text" id="ai-prompt-input" class="text-input" placeholder="Contoh: metode diskusi kelompok, studi kasus nyata...">
            </div>
            <div id="ai-loading" class="hidden items-center justify-center h-24 text-center"><div class="loader"></div><p class="ml-4 text-gray-600">Sedang memproses...</p></div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="aiModalCancelBtn" class="action-button secondary">Batal</button>
                <button id="aiModalGenerateBtn" class="action-button bg-violet-600 hover:bg-violet-700">Buat Konten</button>
            </div>
        </div>
    </div>

    <!-- Bulk Loader Overlay -->
    <div id="bulk-loader-overlay" class="modal-overlay">
        <div class="modal-content text-center">
            <div class="flex items-center justify-center">
                <div class="loader"></div>
                <p id="bulk-loader-message" class="ml-4 text-gray-600">Sedang memproses semua bagian...</p>
            </div>
            <p class="text-sm text-gray-500 mt-4">Mohon tunggu, ini mungkin memakan waktu sejenak.</p>
        </div>
    </div>


    <div id="toast"><p id="toastMessage"></p></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- CONSTANTS & STATE ---
            const STORAGE_KEY = 'rpmInteractiveData';
            let currentAiTarget = null;
            let currentAiPromptKey = null;

            const teacherData = {
                "Dra. Sri Mularsih": "196706201994122001", "Drs. Fiva Widiarto": "196510231996011002", "Wahyu Budi Susapti, S.Pd, MM.": "197207291997022002",
                "Marwoto, S.Pd, S.Kom": "196904082000121001", "Sri Endah Swarastuti, S.Pd": "197407022003122004", "Dra. Cukat Budi Rahayu": "196901121994032010",
                "Dra. Diah Ayu Supriyanti": "196603261994122004", "Justina Trirahaju Leksanawati, S.Pd., M.Si.": "197104162003122006", "Sri Wahyuni, S.Pd": "197008022002122004",
                "Dwi Agus Tri M.M., S.Pd": "197102232002122004", "Sumardi, S.Pd., S.Kom": "197305272003121002", "Agung Pamuji, S.Pd": "197402132005011008",
                "Retnowati, S.Pd": "197303272005012009", "Tony Eka Martin Wibowo, S.Si.": "197912092005011004", "Nur Romlah, S.Pd": "197509082008012008",
                "Deddy Suwito, S.Kom": "197209022006041013", "Agus Wuryanto, S.Pd": "197503222006041002", "Tri Puji Utami, S.Kom": "198304252009032009",
                "Puji Pertiwi Sayekti, S.Pd": "196805102005012011", "Nur Fajriyahti, S.Pd.": "197005212007012014", "Srirahayu, S.Pd.": "197408042008012009",
                "Romidin, S.Pd": "197505052008011021", "Teguh Cahyono, S.Pd.": "198110232006041010", "Seto Eko Purwanto, S.Si": "197804232010011009",
                "Nelly Amaliyah, S.Psi": "197907032010012019", "Satyo Nugroho, S.Kom.": "197807142009031006", "Suratno, S.Pd": "198409032010011012",
                "Vektor Realita Aditopo, S.Pd": "198603312011011003", "Adi Setiawan, S.Pd.": "199012292014021001", "Galih Tyas Anjari, S.Pd.": "199201212014022001",
                "Deti Lestiyorini, S.Pd.": "198912142014022001", "Mahzun, S.Pd I": "197601072008011009", "Sugeng Pitoyo, S.Pd.": "197311032008011002",
                "Asriyatun, S.Pd": "199208262020122009", "Nur Laeli, S.Pd": "199704112020122011", "Sepudin Zupri, S.Kom": "197010222022211001",
                "Arif Nurokhman, S.Pd": "198010172022211002", "Elis Sugiarti, S.Pd.": "198503072022212028", "Sudiyarti, S.Pd": "198511182022212012",
                "Otiah, S.Pd.": "198802242022212013", "Novaristya Widyasmara Pamungkas, S.Pd": "198811042022211004", "Menik Yuni Hartini, S.Pd.": "198906292022212008",
                "Baiq Nur Aisyah, S.Pd.": "198909222022212005", "Sulistiono, S.Pd.": "199112202022211007", "Isria Rizqona Firdausyi, S.Pd.": "199201312022212011",
                "Hindun Fatmawati, S.Pd.": "199210042022212007", "Ana Nurlatifah, S.Pd.": "199304032022212014", "Dwi Inayah Rahmawati, M.Pd.": "199311282022212011",
                "Danu Dwi Jatmiko, S.Pd.": "199401192022211003", "Restu Afri Widhi Hastutiningsih, S.Pd.": "199604032022212009", "Nining Setiani, S.Pd.": "199610102022212008",
                "Kukuh Pribadi, S.Pd.": "198610232022211006", "Yekti Apriyoni, S.Pd.": "197804272023212002", "Novita Adhimurti, S.Pd.": "197811142023212001",
                "Khamsyatun Yudiana, S.Pd.I.": "198207132023212011", "Nanang Cahyana, S.Pd.Ing.": "198603172023211003", "Waskito Ismu Hastomo, S.Pd.": "198606092023211007",
                "Lely Erawati, S.Pd.": "198708212023212018", "Septian Endro Laksono, S.Pd.": "199009052023211004", "Firmanika Rozaqi, S.Pd.": "199104242023212024",
                "Devi Artati, S.Pd.": "199210112023212020", "Soviatun Khasanah, S.Pd.": "199606302023212006", "Miftah Iskandar, S.Pd.": "198512112023211006",
                "Dista Puspitasari Adi, S.Pd.": "198603182024212004", "Rita Wijiarti, S.Pd.": "199410172024212021", "Safa Aulia Astri, S.Sos": "199607212024212021",
                "Agus Sutono, S.Pd.": "197406182025211007", "Yanti Karadina, S.Pd.": "197512172025212006", "Widia Sukaesih, S.E.": "197810082025212008",
                "Triyanto, S.Pd.": "198411252025211021", "Inayatul Munawaroh, S.Pd.": "199301062025212023", "Danu Setio Aji, S.Pd.": "199310162025211021",
                "Hera Dwi Suryandari, S.Pd.": "199312262025212012", "Slamet Suparman, S.Pd.": "-", "Devi Dwi Wahyuni, S.Pd.": "-", "Muhammad Idris Afandi, S.S., M.Pd.": "-"
            };

            // --- PROMPT TEMPLATES (UPDATED) ---
            const PROMPT_TEMPLATES = {
                'identifikasi_murid': `Saya ingin menuliskan identifikasi murid Berdasarkan tujuan pembelajaran {TUJUAN_PEMBELAJARAN}, saya mengidentifikasi kesiapan peserta didik dari aspek pengetahuan awal, minat belajar, dan kebutuhan individual. Identifikasi ini akan membantu saya menyusun strategi dan pendekatan pembelajaran yang tepat agar setiap siswa dapat mencapai kompetensi yang diharapkan. Sajikan dalam bentuk daftar poin. Hindari penggunaan format Markdown (seperti tanda bintang untuk tebal atau daftar).`,
                'identifikasi_materi': `Saya ingin menuliskan identifikasi materi pelajaran berdasarkan tujuan pembelajaran {TUJUAN_PEMBELAJARAN}, materi pelajaran mencakup pengetahuan faktual, konseptual, prosedural, dan metakognitif. Materi dirancang relevan dengan kehidupan nyata peserta didik dan aplikatif dalam berbagai konteks, serta memperkuat nilai karakter yang mendukung pembelajaran bermakna dan menyenangkan. Sajikan dalam bentuk daftar poin. Hindari penggunaan format Markdown.`,
                'lintas_disiplin': `Saya ingin menuliskan lintas disiplin ilmu berdasarkan tujuan pembelajaran {TUJUAN_PEMBELAJARAN}, pembelajaran dapat diintegrasikan lintas disiplin, khususnya dengan mata pelajaran yang mendukung penguatan pemahaman siswa secara holistik. Hal ini akan memperluas wawasan dan memberi makna kontekstual dalam pembelajaran. Sajikan dalam bentuk daftar poin. Hindari penggunaan format Markdown.`,
                'tujuan_pembelajaran': `Anda adalah guru {MATA_PELAJARAN} kelas {KELAS} fase {FASE} yang akan merancang modul ajar pembelajaran mendalam berdasarkan capaian pembelajaran "{CAPAIAN_PEMBELAJARAN}", saya ingin menyusun tujuan pembelajaran yang merinci kompetensi yang harus dikuasai murid dalam beberapa pertemuan. Tujuan pembelajaran akan dirumuskan secara spesifik dan terukur dengan memuat subjek belajar (Audience), kata kerja operasional (Behavior), konteks (Condition), dan tingkat pencapaian (Degree). Kata kerja operasional mengandung level kognitif taksonomi bloom yaitu menerapkan dan menganalisis. Tujuan ini akan menjadi dasar dalam merancang aktivitas belajar, pengalaman bermakna, dan asesmen yang relevan. Buatkan Tujuan untuk pembelajaran beberapa pertemuan dan dituliskan setiap pertemuan. Sajikan dalam bentuk daftar poin. Hindari penggunaan format Markdown.`,
                'topik_pembelajaran': `Tuliskan rekomendasi topik pembelajaran berdasarkan tujuan pembelajaran {TUJUAN_PEMBELAJARAN}, topik pembelajaran ditentukan agar sesuai dengan kebutuhan peserta didik dan mampu mendorong pembelajaran yang mendalam serta kontekstual. Topik ini juga mendukung pengembangan kompetensi yang utuh secara pengetahuan, keterampilan, dan sikap. Buatkan topiknya untuk beberapa pertemuan. Sajikan dalam bentuk daftar poin. Hindari penggunaan format Markdown.`,
                'praktik_pedagogis': `Berikan rekomendasi Model/Strategi/Metode berdasarkan tujuan pembelajaran {TUJUAN_PEMBELAJARAN}, yang mendukung aktivitas belajar aktif, kolaboratif, dan bermakna. Uraikan berdasarkan kesesuaian dengan Tujuan Pembelajaran tersebut untuk beberapa pertemuan. Model pembelajaran akan digunakan untuk mendorong keterlibatan peserta didik secara optimal untuk mencapai dimensi profil lulusan penalaran kritis, kolaborasi, dan komunikasi. Sajikan dalam bentuk daftar poin, bukan uraian teks. Berikan rekomendasi untuk setiap pertemuan meliputi model, metode, strategi. Hindari penggunaan format Markdown.`,
                'kemitraan_pembelajaran': `Tuliskan rekomendasi siapa saja mitra pembelajaran yang dapat berkolaborasi dan berperan berdasarkan tujuan pembelajaran {TUJUAN_PEMBELAJARAN}, pembelajaran akan melibatkan kolaborasi dengan berbagai pihak seperti guru lain, orang tua, atau komunitas. Kemitraan ini bertujuan memperluas makna pembelajaran dan menumbuhkan keterlibatan peserta didik secara sosial. Sajikan dalam bentuk daftar poin, bukan uraian teks. Hindari penggunaan format Markdown.`,
                'lingkungan_pembelajaran': `Tuliskan identifikasi lingkungan belajar berdasarkan tujuan pembelajaran {TUJUAN_PEMBELAJARAN}, lingkungan pembelajaran dirancang agar mendukung interaksi aktif antara peserta didik melalui kombinasi ruang fisik, virtual, dan budaya belajar yang positif. Lingkungan ini akan mendorong siswa menjadi pembelajar yang reflektif dan mandiri. Sajikan dalam bentuk daftar poin, bukan uraian teks. Hindari penggunaan format Markdown.`,
                'pemanfaatan_digital': `Berikan rekomendasi 3 jenis pemanfaatan digital berdasarkan tujuan pembelajaran {TUJUAN_PEMBELAJARAN}, saya akan memanfaatkan teknologi digital untuk memperkuat interaksi, kolaborasi, serta asesmen dalam pembelajaran. Teknologi yang digunakan akan disesuaikan agar mendukung prinsip pembelajaran yang bermakna dan menggembirakan. Sajikan dalam bentuk daftar poin, bukan uraian teks. Hindari penggunaan format Markdown.`,
                'pengalaman_awal': `Buatkan secara ringkas dan jelas langkah kegiatan awal dengan durasi 15 menit berdasarkan tujuan pembelajaran {TUJUAN_PEMBELAJARAN}, Susunlah kegiatan awal yang menerapkan prinsip pembelajaran berkesadaran, bermakna, dan menggembirakan. Kegiatan ini mencakup apersepsi, motivasi, dan pengkondisian yang membangun semangat serta keterhubungan dengan pengalaman siswa. Awali dengan mengucap salam kemudian kegiatan berdoa dan mengecek kehadiran. Identifikasi prinsip pembelajaran yang digunakan. Sajikan dalam format teks biasa tanpa Markdown.`,
                'pengalaman_inti': `Buatkan Langkah-langkah kegiatan inti dengan durasi 260 menit (atau menyesuaikan kebutuhan) berdasarkan tujuan pembelajaran {TUJUAN_PEMBELAJARAN}. Prinsip pembelajaran yang digunakan tetap mindful (berkesadaran), meaningful (bermakna), dan joyful (menggembirakan) agar peserta didik aktif menggali makna dari materi. Identifikasi prinsip pembelajaran yang digunakan. Buatkan aktivitas pembelajaran pada pembelajaran mendalam dengan tahapan sebagai berikut: Memahami, Mengaplikasikan, Merefleksi. Aktivitas pembelajaran yang memuat memahami, mengaplikasikan, merefleksi memiliki kaitan dengan sintaks dan metode pembelajaran dari: {PRAKTIK_PEDAGOGIS}. Kegiatan pembelajaran inti untuk menggali Dimensi Profil Lulusan (DPL) yaitu kemampuan penalaran kritis, kolaborasi, dan komunikasi. DPL dituliskan diakhir kalimat pada aktivitas dengan diberi tanda kurung. Topik pembelajaran adalah {TOPIK}. Sajikan dalam format teks biasa tanpa Markdown.`,
                'pengalaman_penutup': `Buatkan secara ringkas dan jelas langkah kegiatan penutup dengan durasi 5 menit berdasarkan tujuan pembelajaran {TUJUAN_PEMBELAJARAN}, penutup pembelajaran dilakukan dengan menyimpulkan materi, memberikan umpan balik, merencanakan kegiatan selanjutnya dan doa kemudian diakhiri salam. Identifikasi prinsip pembelajaran yang digunakan. Sajikan dalam format teks biasa tanpa Markdown.`,
                'asesmen_awal': `Buatkan asesmen awal berdasarkan tujuan pembelajaran {TUJUAN_PEMBELAJARAN} untuk mengetahui kesiapan dan pengetahuan awal peserta didik. Buatkan 2 atau 3 soal beserta jawabannya (pilih antara esai, uraian, atau pilihan ganda) sesuai level kognitif menerapkan dan menganalisis. Sajikan dalam format teks biasa tanpa Markdown.`,
                'asesmen_proses': `Buatkan asesmen pada proses pembelajaran berdasarkan tujuan pembelajaran {TUJUAN_PEMBELAJARAN}. Fokus pada observasi dan diskusi. Buatkan satu contoh rubrik penilaian sederhana dalam bentuk tabel yang menilai 2 atau 3 aspek (misal: kolaborasi, komunikasi). Sertakan rangkuman singkat tentang jenis, bentuk, dan teknik asesmen formatif yang relevan di awal. Sajikan dalam format teks biasa tanpa Markdown.`,
                'asesmen_akhir': `Buatkan asesmen pada akhir pembelajaran berdasarkan tujuan pembelajaran {TUJUAN_PEMBELAJARAN}. Buatkan 5 soal Pilihan Ganda (PG) tingkat HOTS (Higher-Order Thinking Skills) beserta kunci jawabannya. Sertakan juga kisi-kisi singkat untuk kelima soal tersebut. Sajikan dalam format teks biasa tanpa Markdown.`,
                'lampiran_diagnostik': `Buatkan instrumen tes diagnostik non-kognitif peserta didik dalam format dokumen Word yang rapi, sistematis, dan siap cetak. Instrumen ini ditujukan untuk peserta didik jenjang {KELAS}  Fase {FASE} dan mencakup 10 aspek utama sebagai berikut: 1. Identitas Peserta Didik (Nama Lengkap, Nama Panggilan, Kelas, No Absen, Tanggal Pengisisan), 2. Petunjuk Pengisian, 3. Minat Belajar (4 pernyataan, skala Likert 15), 4. Motivasi Belajar (4 pernyataan, skala Likert 15), 5. Sikap terhadap Pembelajaran (4 pernyataan, skala Likert 15), 6. Gaya Belajar (1 pertanyaan pilihan ganda: Visual, Auditori, Kinestetik, dengan deskripsi singkat untuk tiap pilihan), 7. Kecerdasan Emosional (4 pernyataan, skala Likert 15), 8. Penyesuaian Sosial (4 pernyataan, skala Likert 15), 9. Relasi Sosial dalam Lingkup Keluarga (4 pernyataan, skala Likert 15), 10. Kebiasaan Belajar di Rumah (4 pernyataan, skala Likert 15), 11. Refleksi Diri (3 pertanyaan isian singkat terbuka). Formatkan bagian skala Likert dalam bentuk tabel agar mudah dibaca dan diisi, dengan kolom: Sangat Tidak Setuju  Tidak Setuju  Netral  Setuju  Sangat Setuju. Gunakan bahasa yang sesuai dengan jenjang dan usia peserta didik, serta susun dengan heading dan subjudul yang jelas untuk tiap bagian. Tambahkan: Judul di bagian atas dokumen : INSTRUMEN TES DIAGNOSTIK NON-KOGNITIF PESERTA DIDIK, Catatan penutup untuk guru, tentang bagaimana hasil instrumen ini dapat digunakan untuk merancang pembelajaran berdiferensiasi, serta mendukung komunikasi antara sekolah dan keluarga. Formatkan hasil akhir dalam bentuk teks yang siap disalin dan tanpa Markdown.`,
                'lampiran_rubrik_diskusi': `Berdasarkan tujuan pembelajaran {TUJUAN_PEMBELAJARAN}, saya ingin membuat rubrik penilaian untuk aktivitas diskusi yang menilai kemampuan peserta didik dalam berkolaborasi, menyampaikan pendapat, memunculkan ide, serta bekerja sama secara aktif dalam kelompok. Rubrik disusun dalam bentuk tabel yang memuat aspek penilaian, indikator, skala penilaian (15), serta deskripsi kinerja peserta didik pada setiap tingkat pencapaian. Penilaian ini digunakan untuk mengukur keterampilan komunikasi, kerja sama tim, dan partisipasi aktif peserta didik dalam proses pembelajaran. Sajikan dalam format teks biasa tanpa Markdown.`,
                'lampiran_rubrik_presentasi': `Berdasarkan tujuan pembelajaran {TUJUAN_PEMBELAJARAN}, saya ingin menyusun rubrik penilaian untuk aktivitas presentasi yang menilai kemampuan peserta didik dalam berbicara di depan umum, keberanian mengajukan pertanyaan terhadap hasil kerja kelompok lain, serta kontribusi dalam memaksimalkan kerja kelompok. Rubrik disusun dalam format tabel yang mencakup aspek penilaian, indikator ketercapaian, skala penilaian (15), dan deskripsi performa pada setiap tingkat. Penilaian ini bertujuan mengukur keterampilan komunikasi, keberanian, serta akuntabilitas peserta didik dalam kegiatan presentasi. Sajikan dalam format teks biasa tanpa Markdown.`,
                'lampiran_lkpd': `Anda adalah seorang Guru {MATA_PELAJARAN} kelas {KELAS} fase {FASE}. Buatkan Lembar Kerja Peserta Didik (LKPD) yang lengkap dan terstruktur berdasarkan sintaks pembelajaran {PRAKTIK_PEDAGOGIS}, dengan topik {TOPIK}. Tujuan pembelajaran yang menjadi acuan adalah {TUJUAN_PEMBELAJARAN}. LKPD ini bertujuan untuk mengembangkan dimensi profil lulusan yang relevan. LKPD harus mencakup bagian-bagian berikut secara lengkap: Identitas diri di LKPD: nama peserta didik, mata pelajaran, no absen, kelas, tanggal. Petunjuk penggunaan LKPD: berisi instruksi langkah-langkah mengerjakan, alat yang dibutuhkan, dan cara menjawab. Sintaks Pembelajaran, tuliskan tahapan kegiatan belajar sesuai sintaks, lalu berikan aktivitas siswa dan kolom untuk siswa mengerjakan. Pengalaman Belajar Mendalam, mencakup: Memahami: sajikan materi, gambar, atau teks ringkas yang harus diamati/dibaca, lalu berikan pertanyaan pemahaman (minimal 3 soal). Mengaplikasikan: buat tugas kasus nyata yang sesuai konteks kehidupan siswa, berikan instruksi kerja yang jelas, dan ruang jawaban siswa. Merefleksikan: berikan pertanyaan refleksi (23 soal) yang menuntun siswa untuk meninjau proses belajarnya, kesulitan yang dihadapi, serta rencana perbaikan atau tindak lanjut. Bagian Penutup: ucapan penyemangat, catatan guru (opsional), serta kolom cek pemahaman diri siswa (checklist atau skala sederhana). Gunakan bahasa yang komunikatif, sesuai jenjang, dan dorong pembelajaran aktif, bermakna, berkesadaran, dan menggembirakan. LKPD harus muncul secara utuh dengan isi yang lengkap, bukan hanya berupa kerangka atau daftar isi. Sajikan dalam format teks biasa tanpa Markdown.`,
                'lampiran_materi': `Anda adalah seorang Guru {MATA_PELAJARAN} kelas {KELAS} fase {FASE}. Buatkan materi ajar lengkap dengan topik {TOPIK} dan mengacu pada tujuan pembelajaran {TUJUAN_PEMBELAJARAN}. Materi ajar harus mendukung pengembangan dimensi profil lulusan yang relevan. Materi ajar harus ditulis secara utuh, mencakup: Judul dan Tujuan Pembelajaran di bagian awal. Pendahuluan atau Apersepsi: paragraf pembuka yang menghubungkan materi dengan kehidupan nyata siswa atau pengetahuan sebelumnya. Isi Materi: jelaskan secara sistematis konsep utama, fakta, prosedur, atau prinsip yang perlu dipahami siswa. Sertakan contoh konkret, ilustrasi, atau analogi. Tugas Ringan atau Pemantik Diskusi: berikan 23 pertanyaan atau tugas singkat untuk menguji pemahaman awal. Penutup dan Refleksi Singkat: rangkuman poin penting dan ajakan untuk berpikir kritis atau melanjutkan eksplorasi. Gunakan gaya bahasa yang komunikatif, sesuai dengan jenjang usia peserta didik, serta dukung pembelajaran aktif, kontekstual, dan menyenangkan. Materi ajar harus bisa digunakan langsung oleh guru untuk kegiatan belajar di kelas maupun pembelajaran mandiri. Sajikan dalam format teks biasa tanpa Markdown.`
            };
            
            // --- DOM Element Selection ---
            const printBtn = document.getElementById('printBtn');
            const saveBtn = document.getElementById('saveBtn');
            const clearBtn = document.getElementById('clearBtn');
            const generateAllBtn = document.getElementById('generateAllBtn');
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('main > div, main > section');
            const namaGuruInput = document.getElementById('nama-guru');
            const nipGuruInput = document.getElementById('nip-guru');
            const guruNameSignature = document.getElementById('guru-name-signature');
            const guruNipSignature = document.getElementById('guru-nip-signature');
            const textareas = document.querySelectorAll('.textarea-input');
            const formInputs = document.querySelectorAll('.text-input, .textarea-input, input[type="checkbox"]');
           
            const confirmationModal = document.getElementById('confirmationModal');
            const modalCancelBtn = document.getElementById('modalCancelBtn');
           
            const uploadSignatureBtn = document.getElementById('upload-signature-btn');
            const signatureUploadInput = document.getElementById('signature-upload-input');
            const guruSignatureImg = document.getElementById('guru-signature-img');

            const aiButtons = document.querySelectorAll('.ai-button');
            const aiModal = document.getElementById('aiModal');
            const aiModalTitle = document.getElementById('aiModalTitle');
            const aiModalGenerateBtn = document.getElementById('aiModalGenerateBtn');
            const aiModalCancelBtn = document.getElementById('aiModalCancelBtn');
            const aiPromptInput = document.getElementById('ai-prompt-input');
            const aiLoading = document.getElementById('ai-loading');
           
            const toast = document.getElementById('toast');
            const autocompleteList = document.getElementById('autocomplete-list');
            const bulkLoaderOverlay = document.getElementById('bulk-loader-overlay');

            const SECTIONS_TO_GENERATE = [
                { promptKey: 'identifikasi_murid', target: 'identifikasi-peserta', title: 'Identifikasi Murid' },
                { promptKey: 'identifikasi_materi', target: 'identifikasi-materi', title: 'Identifikasi Materi' },
                { promptKey: 'lintas_disiplin', target: 'desain-lintas-disiplin', title: 'Lintas Disiplin' },
                { promptKey: 'topik_pembelajaran', target: 'desain-topik', title: 'Topik Pembelajaran' },
                { promptKey: 'praktik_pedagogis', target: 'desain-pedagogis', title: 'Praktik Pedagogis' },
                { promptKey: 'kemitraan_pembelajaran', target: 'desain-kemitraan', title: 'Kemitraan' },
                { promptKey: 'lingkungan_pembelajaran', target: 'desain-lingkungan', title: 'Lingkungan Belajar' },
                { promptKey: 'pemanfaatan_digital', target: 'desain-digital', title: 'Pemanfaatan Digital' },
                { promptKey: 'pengalaman_awal', target: 'pengalaman-awal', title: 'Kegiatan Awal' },
                { promptKey: 'pengalaman_inti', target: 'pengalaman-inti', title: 'Kegiatan Inti' },
                { promptKey: 'pengalaman_penutup', target: 'pengalaman-penutup', title: 'Kegiatan Penutup' },
                { promptKey: 'asesmen_awal', target: 'asesmen-awal', title: 'Asesmen Awal' },
                { promptKey: 'asesmen_proses', target: 'asesmen-proses', title: 'Asesmen Proses' },
                { promptKey: 'asesmen_akhir', target: 'asesmen-akhir', title: 'Asesmen Akhir' },
                { promptKey: 'lampiran_diagnostik', target: 'lampiran-diagnostik', title: 'Lampiran Diagnostik' },
                { promptKey: 'lampiran_rubrik_diskusi', target: 'lampiran-rubrik-diskusi', title: 'Lampiran Rubrik Diskusi' },
                { promptKey: 'lampiran_rubrik_presentasi', target: 'lampiran-rubrik-presentasi', title: 'Lampiran Rubrik Presentasi' },
                { promptKey: 'lampiran_lkpd', target: 'lampiran-lkpd', title: 'Lampiran LKPD' },
                { promptKey: 'lampiran_materi', target: 'lampiran-materi', title: 'Lampiran Materi Ajar' },
            ];
           
            // --- UTILITY FUNCTIONS ---
            const showToast = (message, isSuccess = true) => {
                toast.querySelector('#toastMessage').textContent = message;
                toast.style.backgroundColor = isSuccess ? '#22c55e' : '#ef4444';
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            };

            const showConfirmationModal = (title, message, onConfirm) => {
                confirmationModal.querySelector('#modalTitle').textContent = title;
                confirmationModal.querySelector('#modalMessage').textContent = message;
                confirmationModal.querySelector('#modalConfirmBtn').onclick = () => {
                    onConfirm();
                    hideConfirmationModal();
                };
                confirmationModal.classList.add('visible');
            };

            const hideConfirmationModal = () => confirmationModal.classList.remove('visible');

            const resizeTextarea = (textarea) => {
                if (!textarea) return;
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight) + 'px';
            };

            const setSignatureDate = () => {
                const dateElement = document.getElementById('signature-date');
                const today = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                dateElement.textContent = `Purbalingga, ${today.toLocaleDateString('id-ID', options)}`;
            };

            const setFooterYear = () => {
                document.getElementById('current-year').textContent = new Date().getFullYear();
            };
           
            // --- DATA HANDLING FUNCTIONS ---
            const saveData = () => {
                const data = {};
                formInputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        const key = input.parentElement.textContent.trim();
                        data[key] = input.checked;
                    } else if (input.id) {
                        data[input.id] = input.value;
                    }
                });
               
                const signatureSrc = guruSignatureImg.src;
                if (signatureSrc && signatureSrc.startsWith('data:image')) {
                    data['guruSignatureSrc'] = signatureSrc;
                }

                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                showToast('Progres berhasil disimpan!');
            };

            const loadData = () => {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    formInputs.forEach(input => {
                        if (input.type === 'checkbox') {
                            const key = input.parentElement.textContent.trim();
                            if (data[key] !== undefined) {
                                input.checked = data[key];
                            }
                        } else if (input.id && data[input.id] !== undefined) {
                            input.value = data[input.id];
                        }
                    });

                    if (data['guruSignatureSrc']) {
                        guruSignatureImg.src = data['guruSignatureSrc'];
                        guruSignatureImg.classList.remove('hidden');
                    }

                    namaGuruInput.dispatchEvent(new Event('input'));
                    nipGuruInput.dispatchEvent(new Event('input'));
                    textareas.forEach(resizeTextarea);
                    showToast('Progres sebelumnya berhasil dimuat.');
                    return true;
                }
                return false;
            };

            const clearData = () => {
                formInputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else if (!input.readOnly) {
                        input.value = '';
                    }
                });
               
                guruSignatureImg.src = '';
                guruSignatureImg.classList.add('hidden');

                localStorage.removeItem(STORAGE_KEY);
                namaGuruInput.dispatchEvent(new Event('input'));
                nipGuruInput.dispatchEvent(new Event('input'));
                textareas.forEach(resizeTextarea);
                showToast('Semua isian telah dikosongkan.', false);
            };

            // --- AI & MODAL FUNCTIONS (REFACTORED) ---
            const showAiModal = (target, title, promptKey) => {
                currentAiTarget = target;
                currentAiPromptKey = promptKey;
                aiModalTitle.textContent = `AI untuk ${title}`;
                aiPromptInput.value = '';
                aiLoading.classList.add('hidden');
                aiModalGenerateBtn.style.display = 'inline-flex';
                aiModalCancelBtn.style.display = 'inline-flex';
                aiModal.classList.add('visible');
            };

            const hideAiModal = () => aiModal.classList.remove('visible');

            const getGenerationContext = () => {
                return {
                    MATA_PELAJARAN: document.getElementById('mata-pelajaran').value || '[Belum diisi]',
                    TOPIK: document.getElementById('materi-ajar').value || '[Belum diisi]',
                    KELAS: document.getElementById('kelas').value || '[Belum diisi]',
                    FASE: document.getElementById('fase').value || '[Belum diisi]',
                    TUJUAN_PEMBELAJARAN: document.getElementById('desain-tujuan')?.value || '[Belum diisi]',
                    CAPAIAN_PEMBELAJARAN: document.getElementById('desain-capaian')?.value || '[Belum diisi]',
                    PRAKTIK_PEDAGOGIS: document.getElementById('desain-pedagogis')?.value || '[Belum diisi]'
                };
            };

            const executeAiGeneration = async (promptKey, target, userPrompt = '') => {
                 let promptTemplate = PROMPT_TEMPLATES[promptKey];
                if (!promptTemplate) {
                    showToast(`Error: Prompt template '${promptKey}' tidak ditemukan.`, false);
                    return false;
                }
                
                const context = getGenerationContext();
                let finalPrompt = promptTemplate;
                for (const key in context) {
                    finalPrompt = finalPrompt.replace(new RegExp(`{${key}}`, 'g'), context[key]);
                }
                
                if (userPrompt) {
                    finalPrompt += `\n\nFokus tambahan dari pengguna: "${userPrompt}"`;
                }

                try {
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const needsJson = [].includes(promptKey);
                    
                    const payload = {
                        contents: [{ parts: [{ text: finalPrompt }] }],
                        generationConfig: needsJson ? { responseMimeType: "application/json" } : {}
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        console.error("API Error Body:", errorBody);
                        throw new Error(`API Error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    if (!result.candidates || !result.candidates[0].content || !result.candidates[0].content.parts) {
                        throw new Error("Invalid API response structure.");
                    }
                    const text = result.candidates[0].content.parts[0].text;

                    if (typeof target === 'string') {
                        const targetTextarea = document.getElementById(target);
                        if (targetTextarea) {
                            targetTextarea.value = text.trim();
                            resizeTextarea(targetTextarea);
                        }
                    } else if (Array.isArray(target)) {
                        const parsedJson = JSON.parse(text);
                        target.forEach((id, index) => {
                           const key = Object.keys(parsedJson)[index];
                           if(key) {
                               document.getElementById(id).value = parsedJson[key] || '';
                               resizeTextarea(document.getElementById(id));
                           }
                        });
                    }
                    return true;
                } catch (error) {
                    console.error(`AI Generation Error for ${promptKey}:`, error);
                    showToast(`Gagal membuat konten untuk ${promptKey}.`, false);
                    return false;
                }
            };
           
            const generateAiContent = async () => {
                if (!currentAiTarget || !currentAiPromptKey) return;
                aiLoading.style.display = 'flex';
                aiModalGenerateBtn.style.display = 'none';
                aiModalCancelBtn.style.display = 'none';
                
                const success = await executeAiGeneration(currentAiPromptKey, currentAiTarget, aiPromptInput.value);
                if (success) {
                    showToast('Konten berhasil dibuat oleh AI!');
                }
                hideAiModal();
            };

            const generateAllAiContent = async () => {
                const tujuanPembelajaran = document.getElementById('desain-tujuan').value;
                if (!tujuanPembelajaran.trim()) {
                    showToast('Harap isi "Tujuan Pembelajaran" terlebih dahulu sebelum menggunakan fitur ini.', false);
                    document.getElementById('desain-tujuan').focus();
                    return;
                }

                showConfirmationModal(
                    'Mulai Isi Otomatis?',
                    'Proses ini akan mengisi semua bagian berdasarkan Tujuan Pembelajaran. Ini mungkin memakan waktu beberapa saat. Lanjutkan?',
                    async () => {
                        bulkLoaderOverlay.classList.add('visible');
                        generateAllBtn.disabled = true;
                        generateAllBtn.classList.add('opacity-50', 'cursor-not-allowed');

                        const promises = SECTIONS_TO_GENERATE.map(section => 
                            executeAiGeneration(section.promptKey, section.target)
                        );
                        
                        const results = await Promise.allSettled(promises);

                        bulkLoaderOverlay.classList.remove('visible');
                        generateAllBtn.disabled = false;
                        generateAllBtn.classList.remove('opacity-50', 'cursor-not-allowed');

                        const failedCount = results.filter(r => r.status === 'rejected').length;

                        if (failedCount === 0) {
                            showToast('Semua bagian telah berhasil diisi secara otomatis!', true);
                        } else {
                            showToast(`${failedCount} bagian gagal dibuat. Silakan coba lagi untuk bagian tersebut.`, false);
                            console.error("Gagal membuat beberapa bagian:", results);
                        }
                    }
                );
            };

            // --- EVENT LISTENERS ---
           
            printBtn.addEventListener('click', () => window.print());
            saveBtn.addEventListener('click', saveData);
            clearBtn.addEventListener('click', () => {
                showConfirmationModal('Kosongkan Isian?', 'Semua progres yang belum disimpan akan hilang. Apakah Anda yakin?', clearData);
            });
            generateAllBtn.addEventListener('click', generateAllAiContent);
           
            modalCancelBtn.addEventListener('click', hideConfirmationModal);
            confirmationModal.addEventListener('click', (e) => { if (e.target === confirmationModal) hideConfirmationModal(); });

            uploadSignatureBtn.addEventListener('click', () => {
                signatureUploadInput.click();
            });

            signatureUploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        guruSignatureImg.src = e.target.result;
                        guruSignatureImg.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                } else {
                    showToast('Harap pilih file gambar (PNG/JPEG).', false);
                }
            });

            aiButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.dataset.target;
                    const targetGroup = button.dataset.targetGroup;
                    const title = button.dataset.title;
                    const promptKey = button.dataset.promptKey;
                    const target = targetId ? targetId : (targetGroup ? JSON.parse(targetGroup) : null);
                    if (target) {
                        showAiModal(target, title, promptKey);
                    }
                });
            });


            aiModalGenerateBtn.addEventListener('click', generateAiContent);
            aiModalCancelBtn.addEventListener('click', hideAiModal);
            aiModal.addEventListener('click', (e) => { if (e.target === aiModal) hideAiModal(); });

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        navLinks.forEach(link => {
                            link.classList.toggle('active', link.getAttribute('href').substring(1) === entry.target.id);
                        });
                    }
                });
            }, { rootMargin: '-40% 0px -60% 0px' });
            sections.forEach(section => observer.observe(section));

            namaGuruInput.addEventListener('input', (e) => {
                guruNameSignature.textContent = e.target.value.trim() || '...................................';
                
                const value = namaGuruInput.value.toLowerCase();
                autocompleteList.innerHTML = '';
                if (!value) {
                    autocompleteList.classList.add('hidden');
                    return;
                }

                const filteredNames = Object.keys(teacherData).filter(name =>
                    name.toLowerCase().includes(value)
                );

                if (filteredNames.length > 0) {
                    filteredNames.forEach(name => {
                        const item = document.createElement('div');
                        item.classList.add('autocomplete-item');
                        item.textContent = name;
                        item.addEventListener('click', () => {
                            namaGuruInput.value = name;
                            nipGuruInput.value = teacherData[name];
                            autocompleteList.classList.add('hidden');
                            namaGuruInput.dispatchEvent(new Event('input', { bubbles: true }));
                            nipGuruInput.dispatchEvent(new Event('input', { bubbles: true }));
                        });
                        autocompleteList.appendChild(item);
                    });
                    autocompleteList.classList.remove('hidden');
                } else {
                    autocompleteList.classList.add('hidden');
                }
            });

            nipGuruInput.addEventListener('input', (e) => {
                guruNipSignature.textContent = e.target.value.trim() ? `NIP. ${e.target.value}` : 'NIP. .........................';
            });
            textareas.forEach(textarea => {
                textarea.addEventListener('input', () => resizeTextarea(textarea));
            });

            document.addEventListener('click', (e) => {
                if (e.target !== namaGuruInput) {
                    autocompleteList.classList.add('hidden');
                }
            });
           
            // --- INITIALIZATION ---
            const initialize = () => {
                setSignatureDate();
                setFooterYear();
                if (localStorage.getItem(STORAGE_KEY)) {
                    showConfirmationModal('Progres Ditemukan', 'Terdapat progres yang tersimpan sebelumnya. Apakah Anda ingin memuatnya?', loadData);
                }
            };

            initialize();
        });
    </script>
</body>
</html>

